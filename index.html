<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV –ü–ª–µ–π–ª–∏—Å—Ç | –ü—Ä–æ—Å–º–æ—Ç—Ä M3U</title>
    <link rel="icon" href="https://raw.githubusercontent.com/kyiv14/iptv-online/refs/heads/main/icon.ico">
    
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è "Apple-—Å—Ç–∏–ª—è" */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #f2f2f7;
            padding: 20px;
            margin: 0;
            color: #1c1c1e;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* –°—Ç–∏–ª—å –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #007aff;
            margin-bottom: 20px;
            text-align: center;
        }

        /* –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
        .upload-section {
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #007aff;
            background-color: #ffffff;
            border-radius: 12px;
            text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .upload-section:hover, .upload-section.dragover {
            border-color: #34c759;
            background-color: #e5e5ea;
        }

        .upload-section p {
            margin: 5px 0;
            font-size: 1.1rem;
            color: #3a3a3c;
        }

        .upload-button {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 15px;
        }

        .upload-button:hover {
            background-color: #005bb5;
        }

        #file-input {
            display: none;
        }
        
        /* –°–µ–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ */
        .search-container {
            margin-bottom: 30px;
        }

        #search-input {
            width: 100%;
            padding: 12px 20px;
            font-size: 1rem;
            border: 1px solid #d1d1d6;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #search-input:focus {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }

        /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ü–õ–ê–®–ö–ò) */
        #category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px 0;
            margin-bottom: 20px;
            border-top: 1px solid #d1d1d6;
            border-bottom: 1px solid #d1d1d6;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .category-button {
            display: inline-block;
            background-color: #ff3b30; /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px; /* –û–∫—Ä—É–≥–ª—ã–µ –ø–ª–∞—à–∫–∏ */
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
            flex-shrink: 0;
            user-select: none;
        }
        
        .category-button:hover {
            background-color: #c03126; /* –¢–µ–º–Ω–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }

        .category-button.active {
            background-color: #007aff; /* –°–∏–Ω–∏–π –∞–∫—Ü–µ–Ω—Ç –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        }
        
        /* –°—Ç–∏–ª—å –≥—Ä—É–ø–ø—ã –∫–∞–Ω–∞–ª–æ–≤ */
        h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1c1c1e;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 1px solid #d1d1d6;
            text-align: center; 
        }
        
        /* –°–µ—Ç–∫–∞ –¥–ª—è –ø–ª–∏—Ç–æ–∫ */
        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* –°–∫—Ä—ã—Ç–∏–µ –ø—É—Å—Ç—ã—Ö –≥—Ä—É–ø–ø –ø—Ä–∏ –ø–æ–∏—Å–∫–µ */
        .channel-group-container:empty {
            display: none;
        }

        /* –°—Ç–∏–ª—å –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π –ø–ª–∏—Ç–∫–∏ –∫–∞–Ω–∞–ª–∞ */
        .channel-tile {
            background-color: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            text-align: center;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: default;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            aspect-ratio: 1 / 1;
            min-height: 150px;
            position: relative;
        }
        
        .channel-tile:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }


        .channel-logo {
            width: 80%;
            height: auto;
            max-height: 80%;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        /* –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç –ª–æ–≥–æ—Ç–∏–ø–∞ */
        .logo-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80%;
            height: 80%;
            background-color: #f0f0f0;
            border-radius: 8px;
            color: #888;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .channel-name {
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.2;
            word-break: break-word;
            flex-grow: 0;
            overflow: hidden;
        }
        
        .message {
            color: #3a3a3c;
            font-weight: 500;
            margin-top: 15px;
            text-align: center;
        }
        
        .error-message {
            color: #ff3b30;
        }
        
        .success-message {
            color: #34c759;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>IPTV –ü–ª–µ–π–ª–∏—Å—Ç üì∫</h1>
    
    <div id="uploadSection" class="upload-section">
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –ø–ª–µ–π–ª–∏—Å—Ç–∞ (.m3u, .m3u8) —Å—é–¥–∞</p>
        <button class="upload-button" onclick="document.getElementById('file-input').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        <input type="file" id="file-input" accept=".m3u,.m3u8" />
        <p id="uploadMessage" class="message">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã M3U/M3U8.</p>
    </div>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–∞–Ω–∞–ª–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º..." disabled>
    </div>
    
    <div id="category-filter">
        </div>

    <div id="channel-list">
        <p class="message" style="text-align: center; color: #6c757d;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–ª–µ–π–ª–∏—Å—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤.</p>
    </div>
</div>

<script>
    const PROXY_BASE_URL = window.location.origin + '/api/proxy?url=';
    
    // --- –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ ---

    function parseM3U(content) {
        const lines = content.trim().split('\n');
        const channels = [];
        let currentChannel = { name: '', logo: '', group: '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', url: '' };
        let isInChannelBlock = false;

        const extinfRegex = /#EXTINF:.*?,(.+)/; 
        const logoRegex = /tvg-logo="([^"]*)"/;
        const groupTitleRegex = /group-title="([^"]*)"/;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();

            if (line.startsWith('#EXTINF')) {
                if (isInChannelBlock && currentChannel.name && !currentChannel.url) {
                    currentChannel = { name: '', logo: '', group: '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', url: '' };
                }

                const extinfMatch = line.match(extinfRegex);
                const logoMatch = line.match(logoRegex);
                const groupMatch = line.match(groupTitleRegex);

                if (extinfMatch) {
                    currentChannel.name = extinfMatch[1] ? extinfMatch[1].trim() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª';
                    currentChannel.logo = logoMatch ? logoMatch[1].trim() : '';
                    currentChannel.group = groupMatch ? groupMatch[1].trim() : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                    currentChannel.url = ''; 
                    isInChannelBlock = true;
                }
            } else if (line.startsWith('#EXTGRP:')) {
                if (isInChannelBlock) {
                    currentChannel.group = line.substring(8).trim();
                }
            }
            else if ((line.startsWith('http') || line.startsWith('https')) && line.includes('.m3u')) {
                if (isInChannelBlock && currentChannel.name) { 
                    const originalUrl = line.trim();
                    currentChannel.url = originalUrl; // URL –ø–æ—Ç–æ–∫–∞ –Ω–µ –Ω—É–∂–µ–Ω, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                    channels.push({ ...currentChannel }); 
                    currentChannel = { name: '', logo: '', group: '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', url: '' };
                    isInChannelBlock = false;
                }
            }
        }
        return channels.filter(c => c.name);
    }

    function groupChannels(channels) {
        return channels.map(c => ({
            ...c,
            normalizedName: c.name.toLowerCase(),
            normalizedGroup: c.group.toLowerCase()
        })).reduce((acc, channel) => {
            const group = channel.group || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
            if (!acc[group]) {
                acc[group] = [];
            }
            acc[group].push(channel);
            return acc;
        }, {});
    }

    function renderChannels(groupedChannels) {
        const listContainer = document.getElementById('channel-list');
        listContainer.innerHTML = ''; 
        
        window.allChannelsData = groupedChannels;

        if (Object.keys(groupedChannels).length === 0 || Object.values(groupedChannels).every(arr => arr.length === 0)) {
             listContainer.innerHTML = '<p class="message error-message">–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤.</p>';
             return;
        }
        
        // 1. –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        createCategoryButtons(Object.keys(groupedChannels));

        // 2. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–ª–∏—Ç–æ–∫
        for (const group in groupedChannels) {
            if (groupedChannels[group].length === 0) continue;
            
            const groupContainer = document.createElement('div');
            groupContainer.classList.add('channel-group-container');
            groupContainer.setAttribute('data-category', group); // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

            const groupTitle = document.createElement('h2');
            groupTitle.textContent = group;
            groupContainer.appendChild(groupTitle);

            const grid = document.createElement('ul');
            grid.classList.add('channel-grid');

            groupedChannels[group].forEach(channel => {
                const tile = document.createElement('div'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º div
                tile.classList.add('channel-tile');
                tile.setAttribute('data-name', channel.name); 
                tile.setAttribute('data-group', channel.group); 

                if (channel.logo) {
                    const logo = document.createElement('img');
                    logo.classList.add('channel-logo');
                    logo.src = channel.logo;
                    logo.alt = channel.name;
                    logo.onerror = function() {
                         this.style.display='none';
                         const placeholder = document.createElement('div');
                         placeholder.classList.add('logo-placeholder');
                         placeholder.textContent = channel.name.substring(0, 2).toUpperCase();
                         this.parentNode.insertBefore(placeholder, this.nextSibling);
                    }; 
                    tile.appendChild(logo);
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.classList.add('logo-placeholder');
                    placeholder.textContent = channel.name.substring(0, 2).toUpperCase(); 
                    tile.appendChild(placeholder);
                }

                const name = document.createElement('span');
                name.classList.add('channel-name');
                name.textContent = channel.name;

                tile.appendChild(name);
                grid.appendChild(tile);
            });

            groupContainer.appendChild(grid);
            listContainer.appendChild(groupContainer);
        }
        
        // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        filterChannels(searchInput.value);
    }
    
    // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ---
    function createCategoryButtons(categories) {
        const filterContainer = document.getElementById('category-filter');
        filterContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

        // –ö–Ω–æ–ø–∫–∞ "–í—Å–µ" (All)
        const allButton = document.createElement('button');
        allButton.textContent = '–í—Å–µ (All)';
        allButton.classList.add('category-button', 'active');
        allButton.setAttribute('data-filter', 'all');
        filterContainer.appendChild(allButton);
        
        // –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        categories.forEach(category => {
            const button = document.createElement('button');
            button.textContent = category;
            button.classList.add('category-button');
            button.setAttribute('data-filter', category);
            filterContainer.appendChild(button);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        filterContainer.addEventListener('click', handleCategoryFilterClick);
    }
    
    // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ---
    function handleCategoryFilterClick(event) {
        const target = event.target;
        if (!target.classList.contains('category-button')) return;

        const selectedCategory = target.getAttribute('data-filter');
        const containers = document.querySelectorAll('.channel-group-container');
        const buttons = document.querySelectorAll('.category-button');

        // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
        buttons.forEach(btn => btn.classList.remove('active'));
        target.classList.add('active');
        
        searchInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

        containers.forEach(container => {
            const category = container.getAttribute('data-category');
            
            if (selectedCategory === 'all' || category === selectedCategory) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                container.style.display = '';
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø–ª–∏—Ç–∫–∏ –≤–Ω—É—Ç—Ä–∏ (—Ç.–∫. –ø–æ–∏—Å–∫ —Å–±—Ä–æ—à–µ–Ω)
                container.querySelectorAll('.channel-tile').forEach(tile => {
                     tile.style.display = '';
                });
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                container.style.display = 'none';
            }
        });
        
        // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
        const noResultsMessage = document.querySelector('#channel-list > .message');
        if (noResultsMessage) noResultsMessage.remove();
    }


    // --- –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ ---

    const searchInput = document.getElementById('search-input');

    function filterChannels(searchTerm) {
        const term = searchTerm.toLowerCase();
        const allGroupContainers = document.querySelectorAll('.channel-group-container');
        const filterContainer = document.getElementById('category-filter');
        let visibleChannelsCount = 0;
        
        // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≤–≤–æ–¥–∞
        if (term.length > 0) {
            filterContainer.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('active'));
        }

        allGroupContainers.forEach(groupContainer => {
            const groupTitleEl = groupContainer.querySelector('h2');
            const groupTitle = groupTitleEl ? groupTitleEl.textContent.toLowerCase() : '';
            const tiles = groupContainer.querySelectorAll('.channel-tile');
            
            let hasVisibleTiles = false;

            tiles.forEach(tile => {
                const channelName = tile.getAttribute('data-name').toLowerCase();
                const isMatch = channelName.includes(term) || groupTitle.includes(term);

                if (isMatch) {
                    tile.style.display = '';
                    hasVisibleTiles = true;
                    visibleChannelsCount++;
                } else {
                    tile.style.display = 'none';
                }
            });

            if (hasVisibleTiles) {
                groupContainer.style.display = '';
                groupTitleEl.style.display = '';
            } else {
                groupContainer.style.display = 'none';
            }
        });

        let noResultsMessage = document.querySelector('#channel-list > .message');
        if (noResultsMessage) {
            noResultsMessage.remove();
        }

        if (visibleChannelsCount === 0 && term.length > 0) {
             const messageHTML = `<p class="message error-message">–ü–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}" –∫–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`;
             document.getElementById('channel-list').insertAdjacentHTML('beforeend', messageHTML);
        } else if (visibleChannelsCount === 0 && document.querySelectorAll('.channel-group-container').length === 0) {
             const messageHTML = '<p class="message" style="text-align: center; color: #6c757d;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–ª–µ–π–ª–∏—Å—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤.</p>';
             document.getElementById('channel-list').insertAdjacentHTML('beforeend', messageHTML);
        }
    }

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞ –∫ –ø–æ–ª—é –≤–≤–æ–¥–∞
    searchInput.addEventListener('input', (event) => {
        filterChannels(event.target.value);
    });

    // --- –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ ---
    
    const fileInput = document.getElementById('file-input');
    const uploadSection = document.getElementById('uploadSection');
    const uploadMessage = document.getElementById('uploadMessage');
    const searchInputEl = document.getElementById('search-input');


    // –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–∞–π–ª–∞
    function handleFile(file) {
        if (!file) return;

        uploadMessage.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
        uploadMessage.classList.remove('error-message', 'success-message');
        uploadMessage.classList.add('message');
        searchInputEl.value = ''; 
        searchInputEl.disabled = true; 

        const reader = new FileReader();
        
        reader.onload = function(e) {
            const content = e.target.result;
            
            if (!content.trim().startsWith('#EXTM3U')) {
                uploadMessage.textContent = '–û—à–∏–±–∫–∞: –§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º M3U –ø–ª–µ–π–ª–∏—Å—Ç–æ–º (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç #EXTM3U).';
                uploadMessage.classList.add('error-message');
                document.getElementById('channel-list').innerHTML = '';
                document.getElementById('category-filter').innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞
                return;
            }

            const allChannels = parseM3U(content);
            const grouped = groupChannels(allChannels);
            
            renderChannels(grouped);
            
            if (allChannels.length > 0) {
                 uploadMessage.textContent = `–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${allChannels.length} –∫–∞–Ω–∞–ª–æ–≤.`;
                 uploadMessage.classList.add('success-message');
                 searchInputEl.disabled = false; 
                 filterChannels(searchInputEl.value); 
            } else {
                 uploadMessage.textContent = '–ü–ª–µ–π–ª–∏—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ —Å –∏–º–µ–Ω–∞–º–∏.';
                 uploadMessage.classList.add('error-message');
                 searchInputEl.disabled = true;
                 document.getElementById('category-filter').innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞
            }
        };

        reader.onerror = function() {
            uploadMessage.textContent = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞.';
            uploadMessage.classList.add('error-message');
            document.getElementById('channel-list').innerHTML = '';
            document.getElementById('category-filter').innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞
            searchInputEl.disabled = true;
        };

        reader.readAsText(file);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É/–≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
    fileInput.addEventListener('change', function(event) {
        if (event.target.files.length > 0) {
            handleFile(event.target.files[0]);
            event.target.value = ''; 
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Drag and Drop: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadSection.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadSection.addEventListener(eventName, () => {
            uploadSection.classList.add('dragover');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadSection.addEventListener(eventName, () => {
            uploadSection.classList.remove('dragover');
        }, false);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∞–π–ª–∞
    uploadSection.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    }, false);
    
</script>
</body>
</html>
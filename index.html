<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Плейлист | Просмотр M3U</title>
    <link rel="icon" href="https://raw.githubusercontent.com/kyiv14/iptv-online/refs/heads/main/icon.ico">
    
    <style>
        /* VARIABLES - Соответствуют index.html */
        :root {
            --primary-color: #dc2625; /* Red-700 */
            --secondary-color: #ffffff;
            --background-color: #f5f5f7; 
            --text-color: #1d1d1f;
            --border-color: #e3e3e3; 
            --shadow-color: rgba(0, 0, 0, 0.05);
            --transition-duration: 0.2s;
            --success-color: #34c759; /* Зеленый */
            --error-color: var(--primary-color); /* Красный */
        }
        
        /* BASE STYLES */
        body {
            font-family: 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            background-color: var(--background-color);
            padding: 30px 20px;
            margin: 0;
            color: var(--text-color);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Стиль заголовка */
        h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 30px;
            text-align: center;
        }

        /* Секция загрузки/перетаскивания */
        .upload-section {
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed var(--primary-color);
            background-color: var(--secondary-color);
            border-radius: 18px;
            text-align: center;
            transition: background-color var(--transition-duration), border-color var(--transition-duration);
            box-shadow: 0 4px 12px var(--shadow-color);
            cursor: pointer;
        }

        .upload-section:hover, .upload-section.dragover {
            border-color: var(--success-color);
            background-color: #fafafa;
        }

        .upload-section p {
            margin: 5px 0;
            font-size: 16px;
            color: var(--text-color);
        }

        .upload-button {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-duration) ease;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(220, 38, 37, 0.2);
        }

        .upload-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .upload-button:active {
            transform: translateY(1px) scale(0.99); 
            box-shadow: 0 1px 2px rgba(220, 38, 37, 0.2);
        }


        #file-input {
            display: none;
        }
        
        /* Секция поиска */
        .search-container {
            margin-bottom: 30px;
        }

        #search-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: inset 0 1px 3px var(--shadow-color);
            box-sizing: border-box;
            outline: none;
            color: var(--text-color);
            background: var(--secondary-color);
            transition: border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
        }

        #search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(220, 38, 37, 0.15);
        }

        /* Стиль кнопок категорий (ПЛАШКИ) */
        #category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px 0;
            margin-bottom: 20px;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .category-button {
            display: inline-block;
            background-color: #e9e9e9; 
            color: var(--text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 20px; 
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color var(--transition-duration), box-shadow var(--transition-duration);
            flex-shrink: 0;
            user-select: none;
        }
        
        .category-button:hover {
            background-color: #d8d8d8; 
        }

        .category-button.active {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        /* Стиль группы каналов */
        h2 {
            font-size: 20px; 
            font-weight: 600;
            color: var(--text-color);
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: center; 
        }
        
        /* Сетка для плиток */
        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 20px; 
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Стиль квадратной плитки канала */
        .channel-tile {
            background-color: var(--secondary-color);
            border-radius: 18px; 
            overflow: hidden;
            text-align: center;
            padding: 15px;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: transform var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            aspect-ratio: 1 / 1;
            min-height: 150px;
            position: relative;
        }
        
        .channel-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .channel-tile:active {
            transform: translateY(1px) scale(0.99); 
        }

        .channel-logo {
            width: 80%;
            height: auto;
            max-height: 80%;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
            flex-grow: 1; 
        }
        
        /* Заглушка, если нет логотипа */
        .logo-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80%;
            height: 80%;
            background-color: #f7f7f9;
            border-radius: 8px;
            color: #888;
            font-size: 1.5rem;
            margin-bottom: 10px;
            flex-grow: 1;
        }

        .channel-name {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.2;
            word-break: break-word;
            flex-shrink: 0;
            overflow: hidden;
            max-height: 2.4em; 
        }
        
        .message {
            color: var(--text-color);
            font-weight: 500;
            margin-top: 15px;
            text-align: center;
            font-size: 16px;
        }
        
        .error-message {
            color: var(--error-color);
            font-weight: 600;
        }
        
        .success-message {
            color: var(--success-color);
            font-weight: 600;
        }
        
        /* --- Стили для Модального окна Плеера (Новый блок) --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            overflow: hidden; 
        }

        .modal-content {
            background-color: var(--text-color); /* Темный фон для плеера */
            margin: auto;
            border-radius: 18px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            max-width: 95%;
            width: 90%; 
            max-height: 95%;
            height: 90%;
            position: relative;
            animation: animatetop 0.4s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px;
            color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(28, 28, 30, 0.9); /* Почти черный */
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            position: relative;
            z-index: 10;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 20px;
        }

        .modal-close {
            color: #ccc;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            transition: 0.3s;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: var(--primary-color);
            text-decoration: none;
        }

        #player-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            background-color: #000;
            flex-grow: 1;
        }

        @keyframes animatetop {
            from {opacity: 0}
            to {opacity: 1}
        }

        /* Адаптивность */
        @media (max-width: 740px) {
            .channel-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 15px;
            }
            .modal-content {
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
            }
            .modal-header {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>IPTV Плейлист 📺</h1>
    
    <div id="uploadSection" class="upload-section">
        <p>Загрузите или перетащите файл плейлиста (.m3u, .m3u8) сюда</p>
        <button class="upload-button" onclick="document.getElementById('file-input').click()">Выбрать файл</button>
        <input type="file" id="file-input" accept=".m3u,.m3u8" />
        <p id="uploadMessage" class="message">Поддерживаются файлы M3U/M3U8.</p>
    </div>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="🔍 Поиск по каналам и категориям..." disabled>
    </div>
    
    <div id="category-filter">
        </div>

    <div id="channel-list">
        <p class="message" style="color: #6c757d;">Загрузите плейлист, чтобы увидеть список каналов.</p>
    </div>
</div>

<div id="playerModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 id="modalTitle">Загрузка канала...</h3>
            <span class="modal-close" onclick="closeModal(event)">&times;</span>
        </div>
        <iframe id="player-iframe" src="" allowfullscreen frameborder="0" allow="autoplay"></iframe>
    </div>
</div>

<script>
    // --- Глобальные переменные для работы с модальным окном ---
    const playerModal = document.getElementById('playerModal');
    const playerIframe = document.getElementById('player-iframe');
    const modalTitle = document.getElementById('modalTitle');
    
    // --- Утилитарные функции для парсинга и рендеринга ---

    function parseM3U(content) {
        const lines = content.trim().split('\n');
        const channels = [];
        let currentChannel = { name: '', logo: '', group: 'Без категории', url: '' };
        let isInChannelBlock = false;

        const extinfRegex = /#EXTINF:.*?,(.+)/; 
        const logoRegex = /tvg-logo="([^"]*)"/i; 
        const groupTitleRegex = /group-title="([^"]*)"/i;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();

            if (line.startsWith('#EXTINF')) {
                if (isInChannelBlock && currentChannel.name && !currentChannel.url) {
                    currentChannel = { name: '', logo: '', group: 'Без категории', url: '' };
                }

                const extinfMatch = line.match(extinfRegex);
                const logoMatch = line.match(logoRegex);
                const groupMatch = line.match(groupTitleRegex);

                if (extinfMatch) {
                    currentChannel.name = extinfMatch[1] ? extinfMatch[1].trim() : 'Неизвестный канал';
                    currentChannel.logo = logoMatch ? logoMatch[1].trim() : '';
                    currentChannel.group = groupMatch ? groupMatch[1].trim() : 'Без категории';
                    currentChannel.url = ''; 
                    isInChannelBlock = true;
                }
            } else if (line.startsWith('#EXTGRP:')) {
                if (isInChannelBlock) {
                    currentChannel.group = line.substring(8).trim();
                }
            }
            // Проверка на URL потока
            else if ((line.startsWith('http') || line.startsWith('https')) && line.length > 10) {
                if (isInChannelBlock && currentChannel.name) { 
                    const originalUrl = line.trim();
                    currentChannel.url = originalUrl;
                    channels.push({ ...currentChannel }); 
                    currentChannel = { name: '', logo: '', group: 'Без категории', url: '' };
                    isInChannelBlock = false;
                }
            }
        }
        return channels.filter(c => c.name && c.url); // Фильтруем каналы без URL
    }

    function groupChannels(channels) {
        return channels.map(c => ({
            ...c,
            normalizedName: c.name.toLowerCase(),
            normalizedGroup: c.group.toLowerCase()
        })).reduce((acc, channel) => {
            const group = channel.group || 'Без категории'; 
            if (!acc[group]) {
                acc[group] = [];
            }
            acc[group].push(channel);
            return acc;
        }, {});
    }

    function renderChannels(groupedChannels) {
        const listContainer = document.getElementById('channel-list');
        listContainer.innerHTML = ''; 
        
        window.allChannelsData = groupedChannels;

        const allGroups = Object.keys(groupedChannels);
        if (allGroups.length === 0 || allGroups.every(group => groupedChannels[group].length === 0)) {
             listContainer.innerHTML = '<p class="message error-message">Плейлист пуст или не содержит корректных каналов.</p>';
             document.getElementById('category-filter').innerHTML = '';
             return;
        }
        
        createCategoryButtons(allGroups);

        allGroups.forEach(group => {
            if (groupedChannels[group].length === 0) return;
            
            const groupContainer = document.createElement('div');
            groupContainer.classList.add('channel-group-container');
            groupContainer.setAttribute('data-category', group); 

            const groupTitle = document.createElement('h2');
            groupTitle.textContent = group;
            groupContainer.appendChild(groupTitle);

            const grid = document.createElement('ul');
            grid.classList.add('channel-grid');

            groupedChannels[group].forEach(channel => {
                const tile = document.createElement('a'); 
                // Вместо прямого href, мы будем использовать атрибуты для JS
                tile.href = "#"; // Используем заглушку
                tile.setAttribute('data-url', channel.url); // Сохраняем URL
                tile.setAttribute('data-name', channel.name); // Сохраняем имя
                
                // --- ДОБАВЛЕНИЕ ОБРАБОТЧИКА КЛИКА ---
                tile.addEventListener('click', (e) => {
                    e.preventDefault(); // Запрещаем переход по ссылке
                    openPlayerModal(channel.url, channel.name);
                });
                // ------------------------------------

                tile.classList.add('channel-tile');
                tile.setAttribute('data-name', channel.name); 
                tile.setAttribute('data-group', channel.group); 

                if (channel.logo) {
                    const logo = document.createElement('img');
                    logo.classList.add('channel-logo');
                    logo.src = channel.logo;
                    logo.alt = channel.name;
                    logo.loading = 'lazy'; 
                    logo.onerror = function() {
                         this.style.display='none';
                         const placeholder = document.createElement('div');
                         placeholder.classList.add('logo-placeholder');
                         placeholder.textContent = channel.name ? channel.name.substring(0, 2).toUpperCase() : 'P';
                         this.parentNode.insertBefore(placeholder, this.nextSibling);
                    }; 
                    tile.appendChild(logo);
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.classList.add('logo-placeholder');
                    placeholder.textContent = channel.name ? channel.name.substring(0, 2).toUpperCase() : 'P';
                    tile.appendChild(placeholder);
                }

                const name = document.createElement('span');
                name.classList.add('channel-name');
                name.textContent = channel.name;

                tile.appendChild(name);
                grid.appendChild(tile);
            });

            groupContainer.appendChild(grid);
            listContainer.appendChild(groupContainer);
        });
        
        const allButton = document.querySelector('#category-filter button[data-filter="all"]');
        if(allButton) allButton.classList.add('active');
        filterChannels(searchInput.value);
    }
    
    // --- Функции для Модального окна ---
    
    function openPlayerModal(url, name) {
        modalTitle.textContent = name;
        playerIframe.src = url; // Устанавливаем URL потока
        playerModal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Запрещаем прокрутку фона
    }

    function closeModal(event) {
        // Закрываем, только если клик был по крестику, по фону или по span.modal-close
        if (event.target === playerModal || event.target.className === "modal-close") {
            playerModal.style.display = 'none';
            playerIframe.src = ''; // Останавливаем воспроизведение, очищая src
            modalTitle.textContent = 'Загрузка канала...'; // Сброс
            document.body.style.overflow = ''; // Разрешаем прокрутку фона
        }
    }
    
    // --- Остальные функции (без изменений, но включены для полноты) ---

    function createCategoryButtons(categories) {
        const filterContainer = document.getElementById('category-filter');
        filterContainer.innerHTML = ''; 

        const allButton = document.createElement('button');
        allButton.textContent = 'Все';
        allButton.classList.add('category-button');
        allButton.setAttribute('data-filter', 'all');
        filterContainer.appendChild(allButton);
        
        categories.forEach(category => {
            const button = document.createElement('button');
            button.textContent = category;
            button.classList.add('category-button');
            button.setAttribute('data-filter', category);
            filterContainer.appendChild(button);
        });

        filterContainer.removeEventListener('click', handleCategoryFilterClick); 
        filterContainer.addEventListener('click', handleCategoryFilterClick);
    }
    
    function handleCategoryFilterClick(event) {
        const target = event.target;
        if (!target.classList.contains('category-button')) return;

        const selectedCategory = target.getAttribute('data-filter');
        const containers = document.querySelectorAll('.channel-group-container');
        const buttons = document.querySelectorAll('.category-button');

        buttons.forEach(btn => btn.classList.remove('active'));
        target.classList.add('active');
        
        searchInput.value = ''; 

        let visibleGroupsCount = 0;

        containers.forEach(container => {
            const category = container.getAttribute('data-category');
            
            if (selectedCategory === 'all' || category === selectedCategory) {
                container.style.display = '';
                container.querySelectorAll('.channel-tile').forEach(tile => {
                     tile.style.display = '';
                });
                visibleGroupsCount++;
            } else {
                container.style.display = 'none';
            }
        });
        
        const noResultsMessage = document.querySelector('#channel-list > .message');
        if (noResultsMessage) noResultsMessage.remove();
        
        if (visibleGroupsCount === 0) {
            document.getElementById('channel-list').insertAdjacentHTML('beforeend', '<p class="message error-message">Каналы в этой категории не найдены.</p>');
        }
    }


    const searchInput = document.getElementById('search-input');

    function filterChannels(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        const allGroupContainers = document.querySelectorAll('.channel-group-container');
        let visibleChannelsCount = 0;
        
        if (term.length > 0) {
            document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('active'));
        } else {
            const allButton = document.querySelector('#category-filter button[data-filter="all"]');
            if(allButton) allButton.classList.add('active');
        }

        allGroupContainers.forEach(groupContainer => {
            const groupTitleEl = groupContainer.querySelector('h2');
            const groupTitle = groupTitleEl ? groupTitleEl.textContent.toLowerCase() : '';
            const tiles = groupContainer.querySelectorAll('.channel-tile');
            
            let hasVisibleTiles = false;

            tiles.forEach(tile => {
                const channelName = tile.getAttribute('data-name').toLowerCase();
                const isMatch = channelName.includes(term) || groupTitle.includes(term);

                if (isMatch) {
                    tile.style.display = '';
                    hasVisibleTiles = true;
                    visibleChannelsCount++;
                } else {
                    tile.style.display = 'none';
                }
            });

            if (hasVisibleTiles) {
                groupContainer.style.display = '';
            } else {
                groupContainer.style.display = 'none';
            }
        });

        let noResultsMessage = document.querySelector('#channel-list > .message');
        if (noResultsMessage) {
            noResultsMessage.remove();
        }

        if (visibleChannelsCount === 0 && term.length > 0) {
             const messageHTML = `<p class="message error-message">По запросу "${searchTerm}" каналы не найдены.</p>`;
             document.getElementById('channel-list').insertAdjacentHTML('beforeend', messageHTML);
        }
    }

    searchInput.addEventListener('input', (event) => {
        filterChannels(event.target.value);
    });

    const fileInput = document.getElementById('file-input');
    const uploadSection = document.getElementById('uploadSection');
    const uploadMessage = document.getElementById('uploadMessage');
    const searchInputEl = document.getElementById('search-input');


    function handleFile(file) {
        if (!file) return;

        uploadMessage.textContent = 'Обработка...';
        uploadMessage.classList.remove('error-message', 'success-message');
        uploadMessage.classList.add('message');
        searchInputEl.value = ''; 
        searchInputEl.disabled = true; 
        document.getElementById('channel-list').innerHTML = ''; 
        document.getElementById('category-filter').innerHTML = ''; 

        const reader = new FileReader();
        
        reader.onload = function(e) {
            const content = e.target.result;
            
            if (!content.trim().startsWith('#EXTM3U')) {
                uploadMessage.textContent = 'Ошибка: Файл не является корректным M3U плейлистом (отсутствует #EXTM3U).';
                uploadMessage.classList.add('error-message');
                return;
            }

            const allChannels = parseM3U(content);
            const grouped = groupChannels(allChannels);
            
            renderChannels(grouped);
            
            if (allChannels.length > 0) {
                 uploadMessage.textContent = `Успешно загружено ${allChannels.length} каналов.`;
                 uploadMessage.classList.add('success-message');
                 searchInputEl.disabled = false; 
            } else {
                 uploadMessage.textContent = 'Плейлист загружен, но не содержит корректных каналов.';
                 uploadMessage.classList.add('error-message');
            }
        };

        reader.onerror = function() {
            uploadMessage.textContent = 'Ошибка чтения файла.';
            uploadMessage.classList.add('error-message');
        };

        reader.readAsText(file);
    }

    fileInput.addEventListener('change', function(event) {
        if (event.target.files.length > 0) {
            handleFile(event.target.files[0]);
            event.target.value = ''; 
        }
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadSection.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadSection.addEventListener(eventName, () => {
            uploadSection.classList.add('dragover');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadSection.addEventListener(eventName, () => {
            uploadSection.classList.remove('dragover');
        }, false);
    });

    uploadSection.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    }, false);
    
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV –ü–ª–µ–π–ª–∏—Å—Ç | –ó–∞–≥—Ä—É–∑–∫–∞ M3U</title>
    <link rel="icon" href="https://raw.githubusercontent.com/kyiv14/iptv-online/refs/heads/main/icon.ico">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è "Apple-—Å—Ç–∏–ª—è" */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #f2f2f7; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω –∫–∞–∫ –≤ iOS */
            padding: 20px;
            margin: 0;
            color: #1c1c1e; /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* –°—Ç–∏–ª—å –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #007aff; /* –°–∏–Ω–∏–π –∞–∫—Ü–µ–Ω—Ç Apple */
            margin-bottom: 20px;
            text-align: center;
        }

        /* –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
        .upload-section {
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #007aff;
            background-color: #ffffff;
            border-radius: 12px;
            text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .upload-section:hover, .upload-section.dragover {
            border-color: #34c759; /* –ó–µ–ª–µ–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
            background-color: #e5e5ea;
        }

        .upload-section p {
            margin: 5px 0;
            font-size: 1.1rem;
            color: #3a3a3c;
        }

        .upload-button {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 15px;
        }

        .upload-button:hover {
            background-color: #005bb5;
        }

        #file-input {
            display: none;
        }
        
        /* –°–µ–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ */
        .search-container {
            margin-bottom: 30px;
        }

        #search-input {
            width: 100%;
            padding: 12px 20px;
            font-size: 1rem;
            border: 1px solid #d1d1d6;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #search-input:focus {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }

        /* –°—Ç–∏–ª—å –≥—Ä—É–ø–ø—ã –∫–∞–Ω–∞–ª–æ–≤ */
        h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1c1c1e;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 1px solid #d1d1d6;
            /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
            text-align: center; 
        }
        
        /* –°–µ—Ç–∫–∞ –¥–ª—è –ø–ª–∏—Ç–æ–∫ */
        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* –°–∫—Ä—ã—Ç–∏–µ –ø—É—Å—Ç—ã—Ö –≥—Ä—É–ø–ø –ø—Ä–∏ –ø–æ–∏—Å–∫–µ */
        .channel-group-container:empty {
            display: none;
        }

        /* –°—Ç–∏–ª—å –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π –ø–ª–∏—Ç–∫–∏ –∫–∞–Ω–∞–ª–∞ */
        .channel-tile {
            background-color: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            text-align: center;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            aspect-ratio: 1 / 1;
            min-height: 150px;
            position: relative;
        }

        .channel-tile:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .channel-logo {
            width: 80%;
            height: auto;
            max-height: 80%;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        /* –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç –ª–æ–≥–æ—Ç–∏–ø–∞ */
        .logo-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80%;
            height: 80%;
            background-color: #f0f0f0;
            border-radius: 8px;
            color: #888;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .channel-name {
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.2;
            word-break: break-word;
            flex-grow: 0;
            overflow: hidden;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (—Å—Ç–∏–ª–∏ –Ω–µ –º–µ–Ω—è–ª–∏—Å—å) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 15px;
            position: relative;
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        .message {
            color: #3a3a3c;
            font-weight: 500;
            margin-top: 15px;
            text-align: center;
        }
        
        .error-message {
            color: #ff3b30;
        }
        
        .success-message {
            color: #34c759;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>–ü—Ä–æ—Å–º–æ—Ç—Ä IPTV –ü–ª–µ–π–ª–∏—Å—Ç–æ–≤ üì∫</h1>
    
    <div id="uploadSection" class="upload-section">
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –ø–ª–µ–π–ª–∏—Å—Ç–∞ (.m3u, .m3u8) —Å—é–¥–∞</p>
        <button class="upload-button" onclick="document.getElementById('file-input').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        <input type="file" id="file-input" accept=".m3u,.m3u8" />
        <p id="uploadMessage" class="message">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã M3U/M3U8.</p>
    </div>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–∞–Ω–∞–ª–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º..." disabled>
    </div>

    <div id="channel-list">
        <p class="message" style="text-align: center; color: #6c757d;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–ª–µ–π–ª–∏—Å—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤.</p>
    </div>
</div>

<div id="videoModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3 id="modal-title" style="text-align: center;"></h3>
        <video id="channel-player" width="100%" controls style="max-height: 80vh;">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ HTML5.
        </video>
    </div>
</div>

<script>
    // --- –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ ---

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ M3U-–ø–ª–µ–π–ª–∏—Å—Ç–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    function parseM3U(content) {
        const lines = content.trim().split('\n');
        const channels = [];
        let currentChannel = { name: '', logo: '', group: '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', url: '' };
        let isInChannelBlock = false;

        // –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        const extinfRegex = /#EXTINF:.*?,(.+)/; 
        const logoRegex = /tvg-logo="([^"]*)"/;
        const groupTitleRegex = /group-title="([^"]*)"/;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();

            if (line.startsWith('#EXTINF')) {
                // –ï—Å–ª–∏ –º—ã –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π (–µ—Å–ª–∏ –æ–Ω –Ω–µ –±—ã–ª –∑–∞–ø–∏—Å–∞–Ω)
                if (isInChannelBlock && currentChannel.name && !currentChannel.url) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–∞–Ω–∞–ª, –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ URL
                    currentChannel = { name: '', logo: '', group: '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', url: '' };
                }

                const extinfMatch = line.match(extinfRegex);
                const logoMatch = line.match(logoRegex);
                const groupMatch = line.match(groupTitleRegex);

                if (extinfMatch) {
                    currentChannel.name = extinfMatch[1] ? extinfMatch[1].trim() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª';
                    currentChannel.logo = logoMatch ? logoMatch[1].trim() : '';
                    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–µ–º group-title, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ —Å—Ç—Ä–æ–∫–µ #EXTINF
                    currentChannel.group = groupMatch ? groupMatch[1].trim() : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                    currentChannel.url = ''; 
                    isInChannelBlock = true;
                }
            } else if (line.startsWith('#EXTGRP:')) {
                // –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ —É–∫–∞–∑–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π (–¥–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞)
                if (isInChannelBlock) {
                    currentChannel.group = line.substring(8).trim();
                }
            }
            else if ((line.startsWith('http') || line.startsWith('https')) && line.includes('.m3u')) {
                // –≠—Ç–æ URL –ø–æ—Ç–æ–∫–∞, –∑–∞–≤–µ—Ä—à–∞–µ–º –∫–∞–Ω–∞–ª
                if (isInChannelBlock && currentChannel.name) { 
                    currentChannel.url = line.trim();
                    channels.push({ ...currentChannel }); // –ö–ª–æ–Ω–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
                    currentChannel = { name: '', logo: '', group: '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', url: '' }; // –°–±—Ä–æ—Å
                    isInChannelBlock = false;
                }
            }
        }
        return channels.filter(c => c.url);
    }


    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    function groupChannels(channels) {
        // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–µ –∏–∑–º–µ–Ω—è—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞
        return channels.map(c => ({
            ...c,
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞
            normalizedName: c.name.toLowerCase(),
            normalizedGroup: c.group.toLowerCase()
        })).reduce((acc, channel) => {
            const group = channel.group || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
            if (!acc[group]) {
                acc[group] = [];
            }
            acc[group].push(channel);
            return acc;
        }, {});
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ HTML
    function renderChannels(groupedChannels) {
        const listContainer = document.getElementById('channel-list');
        listContainer.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è –ø–æ–∏—Å–∫–∞
        window.allChannelsData = groupedChannels;

        if (Object.keys(groupedChannels).length === 0 || Object.values(groupedChannels).every(arr => arr.length === 0)) {
             listContainer.innerHTML = '<p class="message error-message">–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤.</p>';
             return;
        }

        for (const group in groupedChannels) {
            if (groupedChannels[group].length === 0) continue;
            
            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä—É–ø–ø—ã (–Ω—É–∂–µ–Ω –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ)
            const groupContainer = document.createElement('div');
            groupContainer.classList.add('channel-group-container');

            const groupTitle = document.createElement('h2');
            groupTitle.textContent = group;
            groupContainer.appendChild(groupTitle);

            const grid = document.createElement('ul');
            grid.classList.add('channel-grid');

            groupedChannels[group].forEach(channel => {
                const tile = document.createElement('a');
                tile.href = '#';
                tile.classList.add('channel-tile');
                tile.setAttribute('data-url', channel.url);
                tile.setAttribute('data-name', channel.name); 
                tile.setAttribute('data-group', channel.group); // –î–ª—è –ø–æ–∏—Å–∫–∞

                // –õ–æ–≥–æ—Ç–∏–ø –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∞
                if (channel.logo) {
                    const logo = document.createElement('img');
                    logo.classList.add('channel-logo');
                    logo.src = channel.logo;
                    logo.alt = channel.name;
                    // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–≥–æ, –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
                    logo.onerror = function() {
                         this.style.display='none';
                         const placeholder = document.createElement('div');
                         placeholder.classList.add('logo-placeholder');
                         placeholder.textContent = channel.name.substring(0, 2).toUpperCase();
                         this.parentNode.insertBefore(placeholder, this.nextSibling);
                    }; 
                    tile.appendChild(logo);
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.classList.add('logo-placeholder');
                    placeholder.textContent = channel.name.substring(0, 2).toUpperCase(); 
                    tile.appendChild(placeholder);
                }

                // –ù–∞–∑–≤–∞–Ω–∏–µ
                const name = document.createElement('span');
                name.classList.add('channel-name');
                name.textContent = channel.name;

                tile.appendChild(name);
                grid.appendChild(tile);
            });

            groupContainer.appendChild(grid);
            listContainer.appendChild(groupContainer);
        }
    }
    
    // --- –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ ---

    const searchInput = document.getElementById('search-input');

    function filterChannels(searchTerm) {
        const term = searchTerm.toLowerCase();
        const allGroupContainers = document.querySelectorAll('.channel-group-container');
        let visibleChannelsCount = 0;
        
        allGroupContainers.forEach(groupContainer => {
            const groupTitleEl = groupContainer.querySelector('h2');
            const groupTitle = groupTitleEl ? groupTitleEl.textContent.toLowerCase() : '';
            const tiles = groupContainer.querySelectorAll('.channel-tile');
            let hasVisibleTiles = false;

            tiles.forEach(tile => {
                const channelName = tile.getAttribute('data-name').toLowerCase();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞ –ò–õ–ò –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã
                const isMatch = channelName.includes(term) || groupTitle.includes(term);

                if (isMatch) {
                    tile.style.display = '';
                    hasVisibleTiles = true;
                    visibleChannelsCount++;
                } else {
                    tile.style.display = 'none';
                }
            });

            // –°–∫—Ä—ã–≤–∞–µ–º –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—é –≥—Ä—É–ø–ø—É
            if (hasVisibleTiles) {
                groupContainer.style.display = '';
                groupTitleEl.style.display = '';
            } else {
                groupContainer.style.display = 'none';
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è "–ö–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        let noResultsMessage = document.querySelector('#channel-list > .message');
        if (noResultsMessage) {
            noResultsMessage.remove();
        }

        if (visibleChannelsCount === 0 && term.length > 0) {
             const messageHTML = `<p class="message error-message">–ü–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}" –∫–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`;
             document.getElementById('channel-list').insertAdjacentHTML('beforeend', messageHTML);
        } else if (visibleChannelsCount === 0 && document.querySelectorAll('.channel-group-container').length === 0) {
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø–ª–µ–π–ª–∏—Å—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
             const messageHTML = '<p class="message" style="text-align: center; color: #6c757d;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–ª–µ–π–ª–∏—Å—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤.</p>';
             document.getElementById('channel-list').insertAdjacentHTML('beforeend', messageHTML);
        }
    }

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞ –∫ –ø–æ–ª—é –≤–≤–æ–¥–∞
    searchInput.addEventListener('input', (event) => {
        filterChannels(event.target.value);
    });

    // --- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ (–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) ---
    
    const modal = document.getElementById('videoModal');
    const closeBtn = document.querySelector('.close-button');
    const player = document.getElementById('channel-player');
    const modalTitle = document.getElementById('modal-title');
    const listContainer = document.getElementById('channel-list');
    let hlsInstance = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–µ—Ä–∞
    function openModal(name, url) {
        modalTitle.textContent = name;
        
        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        player.pause();
        player.src = "";
        if (hlsInstance) { 
             hlsInstance.destroy();
             hlsInstance = null;
        }
        
        // –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è HLS.js
        if (window.Hls && Hls.isSupported()) {
            hlsInstance = new Hls();
            hlsInstance.loadSource(url);
            hlsInstance.attachMedia(player);
        } else if (player.canPlayType('application/vnd.apple.mpegurl') || player.canPlayType('application/x-mpegurl')) {
            // –ù–∞—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ HLS (Safari, iOS)
            player.src = url;
        } else {
            // –ü—Ä–æ—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ URL –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∏–ª–∏ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            player.src = url;
        }
        
        modal.style.display = 'flex';
        player.load();
    }

    function closeModal() {
        player.pause();
        player.src = "";
        if (hlsInstance) { 
             hlsInstance.destroy();
             hlsInstance = null;
        }
        modal.style.display = 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    closeBtn.onclick = closeModal;
    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –ø–ª–∏—Ç–∫–µ
    listContainer.addEventListener('click', function(event) {
        const tile = event.target.closest('.channel-tile');
        if (tile) {
            event.preventDefault();
            // –ù–∞–∑–≤–∞–Ω–∏–µ –±–µ—Ä–µ–º –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–≥–ª—É—à–∫–æ–π
            openModal(tile.getAttribute('data-name'), tile.getAttribute('data-url'));
        }
    });

    // --- –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ ---
    
    const fileInput = document.getElementById('file-input');
    const uploadSection = document.getElementById('uploadSection');
    const uploadMessage = document.getElementById('uploadMessage');
    const searchInputEl = document.getElementById('search-input');


    // –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–∞–π–ª–∞
    function handleFile(file) {
        if (!file) return;

        // –°–±—Ä–æ—Å —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        uploadMessage.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
        uploadMessage.classList.remove('error-message', 'success-message');
        uploadMessage.classList.add('message');
        searchInputEl.value = ''; // –û—á–∏—Å—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
        searchInputEl.disabled = true; // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–∏—Å–∫–∞ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏

        const reader = new FileReader();
        
        reader.onload = function(e) {
            const content = e.target.result;
            
            if (!content.trim().startsWith('#EXTM3U')) {
                uploadMessage.textContent = '–û—à–∏–±–∫–∞: –§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º M3U –ø–ª–µ–π–ª–∏—Å—Ç–æ–º (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç #EXTM3U).';
                uploadMessage.classList.add('error-message');
                listContainer.innerHTML = '';
                return;
            }

            const allChannels = parseM3U(content);
            const grouped = groupChannels(allChannels);
            
            renderChannels(grouped);
            
            if (allChannels.length > 0) {
                 uploadMessage.textContent = `–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${allChannels.length} –∫–∞–Ω–∞–ª–æ–≤.`;
                 uploadMessage.classList.add('success-message');
                 searchInputEl.disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–∏—Å–∫–∞
                 filterChannels(searchInputEl.value); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –≤–≤–µ–¥–µ–Ω–æ
            } else {
                 uploadMessage.textContent = '–ü–ª–µ–π–ª–∏—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ —Å –∞–¥—Ä–µ—Å–∞–º–∏.';
                 uploadMessage.classList.add('error-message');
                 searchInputEl.disabled = true;
            }
        };

        reader.onerror = function() {
            uploadMessage.textContent = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞.';
            uploadMessage.classList.add('error-message');
            listContainer.innerHTML = '';
            searchInputEl.disabled = true;
        };

        reader.readAsText(file);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É/–≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
    fileInput.addEventListener('change', function(event) {
        if (event.target.files.length > 0) {
            handleFile(event.target.files[0]);
            event.target.value = ''; 
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Drag and Drop: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadSection.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadSection.addEventListener(eventName, () => {
            uploadSection.classList.add('dragover');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadSection.addEventListener(eventName, () => {
            uploadSection.classList.remove('dragover');
        }, false);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∞–π–ª–∞
    uploadSection.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    }, false);
    
</script>

</body>
</html>